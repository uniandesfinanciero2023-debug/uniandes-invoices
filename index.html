<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Revisión de Facturas - UNIANDES</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --uniandes-primary: #1B396A;
            --uniandes-secondary: #E63946;
            --uniandes-accent: #F1FAEE;
            --uniandes-light: #A8DADC;
            --uniandes-dark: #457B9D;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .navbar {
            background-color: var(--uniandes-primary);
        }
        
        .navbar-brand {
            font-weight: 700;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--uniandes-primary);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--uniandes-primary);
            border-color: var(--uniandes-primary);
        }
        
        .btn-primary:hover {
            background-color: var(--uniandes-dark);
            border-color: var(--uniandes-dark);
        }
        
        .btn-danger {
            background-color: var(--uniandes-secondary);
            border-color: var(--uniandes-secondary);
        }
        
        .table th {
            background-color: var(--uniandes-light);
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .section-title {
            border-left: 4px solid var(--uniandes-primary);
            padding-left: 10px;
            margin: 20px 0 15px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--uniandes-primary);
        }
        
        .required-field::after {
            content: " *";
            color: var(--uniandes-secondary);
        }
        
        .checklist-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .checklist-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <div class="logo-container">
                <div class="logo">U</div>
                <a class="navbar-brand" href="#">UNIANDES - Cuentas por Pagar</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Formulario de búsqueda -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-search me-2"></i>Buscar Factura
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="invoiceNumber" class="form-label">Número de Factura</label>
                        <input type="text" class="form-control" id="invoiceNumber" placeholder="Ingrese número de factura">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="providerRuc" class="form-label">RUC del Proveedor</label>
                        <input type="text" class="form-control" id="providerRuc" placeholder="Ingrese RUC del proveedor">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="statusFilter" class="form-label">Estado</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Todos</option>
                            <option value="pending">Pendiente de revisión</option>
                            <option value="approved">Aprobado</option>
                            <option value="rejected">Rechazado</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-primary me-2" id="searchButton">
                        <i class="fas fa-search me-1"></i> Buscar
                    </button>
                    <button class="btn btn-outline-secondary" id="clearButton">
                        <i class="fas fa-eraser me-1"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- Resultados de búsqueda -->
        <div class="card mb-4 d-none" id="resultsCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list me-2"></i>Resultados de Búsqueda</span>
                <span class="badge bg-primary" id="resultsCount">0 facturas encontradas</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="resultsTable">
                        <thead>
                            <tr>
                                <th>N° Factura</th>
                                <th>Proveedor</th>
                                <th>RUC</th>
                                <th>Fecha Emisión</th>
                                <th>Valor Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los resultados se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Formulario de revisión -->
        <div class="card mb-4 d-none" id="reviewFormCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-invoice me-2"></i>Revisión de Factura: <span id="currentInvoiceNumber"></span></span>
                <span class="status-badge" id="currentInvoiceStatus">Pendiente</span>
            </div>
            <div class="card-body">
                <h4 class="section-title">1. Tabla Comparativa Principal</h4>
                <div class="table-responsive mb-4">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th></th>
                                <th>CP Comprobante T.</th>
                                <th>Factura Proveedor</th>
                                <th>Retención</th>
                                <th>Visto (✓) / X (NO COINCIDE)</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Documento</strong></td>
                                <td><span id="cpDocNumber"></span></td>
                                <td><span id="invoiceDocNumber"></span></td>
                                <td><span id="retentionDocNumber"></span></td>
                                <td>
                                    <select class="form-select form-select-sm" id="docMatch">
                                        <option value="pending">Pendiente</option>
                                        <option value="yes">✓ Coincide</option>
                                        <option value="no">X No coincide</option>
                                    </select>
                                </td>
                                <td>
                                    <textarea class="form-control form-control-sm" id="docObservations" rows="2" placeholder="Observaciones..."></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Fecha Emisión</strong></td>
                                <td><span id="cpEmissionDate"></span></td>
                                <td><span id="invoiceEmissionDate"></span></td>
                                <td><span id="retentionEmissionDate"></span></td>
                                <td>
                                    <select class="form-select form-select-sm" id="dateMatch">
                                        <option value="pending">Pendiente</option>
                                        <option value="yes">✓ Coincide</option>
                                        <option value="no">X No coincide</option>
                                    </select>
                                </td>
                                <td>
                                    <textarea class="form-control form-control-sm" id="dateObservations" rows="2" placeholder="Observaciones..."></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>RUC</strong></td>
                                <td><span id="cpRuc"></span></td>
                                <td><span id="invoiceRuc"></span></td>
                                <td><span id="retentionRuc"></span></td>
                                <td>
                                    <select class="form-select form-select-sm" id="rucMatch">
                                        <option value="pending">Pendiente</option>
                                        <option value="yes">✓ Coincide</option>
                                        <option value="no">X No coincide</option>
                                    </select>
                                </td>
                                <td>
                                    <textarea class="form-control form-control-sm" id="rucObservations" rows="2" placeholder="Observaciones..."></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Nombre</strong></td>
                                <td><span id="cpName"></span></td>
                                <td><span id="invoiceName"></span></td>
                                <td><span id="retentionName"></span></td>
                                <td>
                                    <select class="form-select form-select-sm" id="nameMatch">
                                        <option value="pending">Pendiente</option>
                                        <option value="yes">✓ Coincide</option>
                                        <option value="no">X No coincide</option>
                                    </select>
                                </td>
                                <td>
                                    <textarea class="form-control form-control-sm" id="nameObservations" rows="2" placeholder="Observaciones..."></textarea>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Valores</strong></td>
                                <td>
                                    CON IVA: <span id="cpWithVAT"></span><br>
                                    CON IVA2: <span id="cpWithVAT2"></span><br>
                                    SIN IVA: <span id="cpWithoutVAT"></span>
                                </td>
                                <td>
                                    Subtotal: <span id="invoiceSubtotal"></span><br>
                                    IVA 12%: <span id="invoiceIVA12"></span><br>
                                    IVA 15%: <span id="invoiceIVA15"></span><br>
                                    Total: <span id="invoiceTotal"></span>
                                </td>
                                <td>
                                    Base Imp. Renta: <span id="retentionRentBase"></span><br>
                                    Base Imp. IVA: <span id="retentionIVABase"></span>
                                </td>
                                <td>
                                    <select class="form-select form-select-sm" id="valuesMatch">
                                        <option value="pending">Pendiente</option>
                                        <option value="yes">✓ Coincide</option>
                                        <option value="no">X No coincide</option>
                                    </select>
                                </td>
                                <td>
                                    <textarea class="form-control form-control-sm" id="valuesObservations" rows="2" placeholder="Observaciones..."></textarea>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4 class="section-title">2. Verificación de Valores e Impuestos</h4>
                <div class="table-responsive mb-4">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Retención</th>
                                <th>CP Comprobante T.</th>
                                <th>Factura Proveedor</th>
                                <th>Coincide</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Base Imp. Renta: <span id="verifRentBase"></span></td>
                                <td>CON IVA/CON IVA2/SIN IVA: <span id="verifCPValues"></span></td>
                                <td>Subtotal: <span id="verifSubtotal"></span></td>
                                <td>
                                    <select class="form-select form-select-sm" id="rentBaseMatch">
                                        <option value="pending">Pendiente</option>
                                        <option value="yes">✓ Coincide</option>
                                        <option value="no">X No coincide</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Base Imp. IVA: <span id="verifIVABase"></span></td>
                                <td>IVA/IVA2: <span id="verifCPIVA"></span></td>
                                <td>IVA (12% o 15%): <span id="verifInvoiceIVA"></span></td>
                                <td>
                                    <select class="form-select form-select-sm" id="ivaBaseMatch">
                                        <option value="pending">Pendiente</option>
                                        <option value="yes">✓ Coincide</option>
                                        <option value="no">X No coincide</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h4 class="section-title">3. Verificación Adicional de Documentos</h4>
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-field">Contrato y vigencia</label>
                        <select class="form-select" id="contractValidation">
                            <option value="pending">Pendiente de verificación</option>
                            <option value="valid">Contrato válido y vigente</option>
                            <option value="invalid">Contrato inválido o no vigente</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-field">Certificación presupuestaria</label>
                        <select class="form-select" id="budgetValidation">
                            <option value="pending">Pendiente de verificación</option>
                            <option value="valid">Certificación válida</option>
                            <option value="invalid">Certificación inválida</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-field">Factura a nombre de UNIANDES</label>
                        <select class="form-select" id="invoiceNameValidation">
                            <option value="pending">Pendiente de verificación</option>
                            <option value="valid">Nombre y RUC correctos</option>
                            <option value="invalid">Nombre o RUC incorrectos</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-field">Tipo de compra</label>
                        <select class="form-select" id="purchaseType">
                            <option value="">Seleccione el tipo</option>
                            <option value="goods">Bienes</option>
                            <option value="services">Servicios</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-field">Retenciones aplicadas</label>
                        <select class="form-select" id="retentionValidation">
                            <option value="pending">Pendiente de verificación</option>
                            <option value="correct">Retenciones aplicadas correctamente</option>
                            <option value="incorrect">Retenciones aplicadas incorrectamente</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-field">Número de retención (Sede/Extensión)</label>
                        <select class="form-select" id="retentionNumberValidation">
                            <option value="pending">Pendiente de verificación</option>
                            <option value="correct">Número corresponde a la sede correcta</option>
                            <option value="incorrect">Número no corresponde a la sede correcta</option>
                        </select>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label">Observaciones adicionales</label>
                        <textarea class="form-control" id="additionalObservations" rows="3" placeholder="Ingrese observaciones adicionales..."></textarea>
                    </div>
                </div>

                <h4 class="section-title">4. Porcentajes de Retención</h4>
                <div class="alert alert-info mb-4">
                    <ul class="mb-0">
                        <li>Honorarios profesionales educativos: 10% (renta), sin IVA.</li>
                        <li>Honorarios profesionales no educativos: 10% (renta) + 100% (IVA).</li>
                        <li>Honorarios profesionales (sociedades): 3% (renta) + 100% (IVA).</li>
                        <li>Bienes (régimen general): 1.75% (renta) + 100% (IVA).</li>
                        <li>Servicios (régimen general): 2.75% (renta) + 100% (IVA).</li>
                        <li>Proveedores RIMPE: 1% (renta) + 100% (IVA).</li>
                        <li>Grandes contribuyentes: No se retiene renta, solo 100% de IVA.</li>
                        <li>Régimen popular con factura electrónica: Sin retenciones.</li>
                    </ul>
                </div>

                <h4 class="section-title">5. Checklist Final de Verificación</h4>
                <div class="card mb-4">
                    <div class="card-body p-0">
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check1">
                                <label class="form-check-label" for="check1">
                                    Coincidencia de números de documento (FC/NV) entre CP, factura y retención.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check2">
                                <label class="form-check-label" for="check2">
                                    Fechas, RUC y nombre del proveedor consistentes en todos los documentos.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check3">
                                <label class="form-check-label" for="check3">
                                    Valores (subtotal, IVA, total) coinciden entre factura y CP.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check4">
                                <label class="form-check-label" for="check4">
                                    Bases imponibles de retención coinciden con los valores sin IVA/con IVA del CP y el subtotal de la factura.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check5">
                                <label class="form-check-label" for="check5">
                                    Retenciones aplicadas correctamente según el tipo de proveedor y servicio.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check6">
                                <label class="form-check-label" for="check6">
                                    Retención del 100% de IVA aplicada (excepto en excepciones).
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check7">
                                <label class="form-check-label" for="check7">
                                    Factura emitida a nombre de UNIANDES con RUC 1890149215001.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check8">
                                <label class="form-check-label" for="check8">
                                    Contrato vigente y certificación presupuestaria en orden.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check9">
                                <label class="form-check-label" for="check9">
                                    Para hoteles: 10% de servicio y tasa hotelera registrados en SIN IVA y excluidos de retención de renta.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check10">
                                <label class="form-check-label" for="check10">
                                    Número de retención corresponde a la sede/extensión correcta.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check11">
                                <label class="form-check-label" for="check11">
                                    Total pagado = Total factura - Retenciones.
                                </label>
                            </div>
                        </div>
                        <div class="checklist-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check12">
                                <label class="form-check-label" for="check12">
                                    Cuentas contables correctas según el gasto.
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-danger" id="rejectButton">
                        <i class="fas fa-times-circle me-1"></i> Rechazar
                    </button>
                    <button class="btn btn-success" id="approveButton">
                        <i class="fas fa-check-circle me-1"></i> Aprobar
                    </button>
                    <button class="btn btn-secondary" id="saveButton">
                        <i class="fas fa-save me-1"></i> Guardar Borrador
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>UNIVERSIDAD REGIONAL AUTÓNOMA DE LOS ANDES</h5>
                    <p>RUC: 1890149215001</p>
                    <p>Sistema de Gestión de Cuentas por Pagar</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>Versión 1.0.0</p>
                    <p>© 2023 - Todos los derechos reservados</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Datos de ejemplo (simulan una base de datos)
        const invoicesData = [
            {
                id: 1,
                invoice_number: "001-001-000000001",
                provider: "Proveedor Ejemplo S.A.",
                ruc: "1790001234001",
                emission_date: "2023-10-15",
                total_value: 1250.75,
                status: "pending",
                cp_doc_number: "FC-2023-0001",
                cp_emission_date: "2023-10-15",
                retention_doc_number: "001002-001-000000123",
                retention_emission_date: "2023-10-16",
                retention_rent_base: 950.00,
                retention_iva_base: 114.00,
                contract_validated: false,
                budget_validated: false,
                invoice_name_validated: false,
                purchase_type: "",
                retention_validated: false,
                retention_number_validated: false,
                additional_observations: ""
            },
            {
                id: 2,
                invoice_number: "001-001-000000002", 
                provider: "Otro Proveedor Cía. Ltda.",
                ruc: "1790005678001",
                emission_date: "2023-10-16",
                total_value: 3200.00,
                status: "approved",
                cp_doc_number: "FC-2023-0002",
                cp_emission_date: "2023-10-16",
                retention_doc_number: "001002-001-000000124",
                retention_emission_date: "2023-10-17",
                retention_rent_base: 2750.00,
                retention_iva_base: 412.50,
                contract_validated: true,
                budget_validated: true,
                invoice_name_validated: true,
                purchase_type: "goods",
                retention_validated: true,
                retention_number_validated: true,
                additional_observations: "Factura aprobada correctamente"
            }
        ];

        // Variables globales
        let currentInvoice = null;
        
        // Elementos DOM
        const alertContainer = document.getElementById('alertContainer');
        const resultsCard = document.getElementById('resultsCard');
        const resultsTable = document.getElementById('resultsTable').querySelector('tbody');
        const resultsCount = document.getElementById('resultsCount');
        const reviewFormCard = document.getElementById('reviewFormCard');
        
        // Event Listeners
        document.getElementById('searchButton').addEventListener('click', searchInvoices);
        document.getElementById('clearButton').addEventListener('click', clearSearch);
        document.getElementById('approveButton').addEventListener('click', approveInvoice);
        document.getElementById('rejectButton').addEventListener('click', rejectInvoice);
        document.getElementById('saveButton').addEventListener('click', saveDraft);
        
        // Funciones
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.classList.remove('show');
                    setTimeout(() => alertContainer.removeChild(alert), 500);
                }
            }, 5000);
        }
        
        function searchInvoices() {
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const providerRuc = document.getElementById('providerRuc').value;
            const status = document.getElementById('statusFilter').value;
            
            // Filtrar datos
            let resultados = invoicesData;
            
            if (invoiceNumber) {
                resultados = resultados.filter(item => 
                    item.invoice_number.includes(invoiceNumber));
            }
            
            if (providerRuc) {
                resultados = resultados.filter(item => item.ruc === providerRuc);
            }
            
            if (status) {
                resultados = resultados.filter(item => item.status === status);
            }
            
            displayResults(resultados);
        }
        
        function displayResults(data) {
            resultsTable.innerHTML = '';
            
            if (data.length === 0) {
                resultsCard.classList.add('d-none');
                showAlert('No se encontraron facturas con los criterios de búsqueda especificados.', 'info');
                return;
            }
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                let statusBadge;
                if (item.status === 'pending') {
                    statusBadge = '<span class="status-badge status-pending">Pendiente</span>';
                } else if (item.status === 'approved') {
                    statusBadge = '<span class="status-badge status-approved">Aprobado</span>';
                } else {
                    statusBadge = '<span class="status-badge status-rejected">Rechazado</span>';
                }
                
                row.innerHTML = `
                    <td>${item.invoice_number}</td>
                    <td>${item.provider}</td>
                    <td>${item.ruc}</td>
                    <td>${item.emission_date}</td>
                    <td>$${item.total_value.toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary review-btn" data-id="${item.id}">
                            <i class="fas fa-edit"></i> Revisar
                        </button>
                    </td>
                `;
                
                resultsTable.appendChild(row);
            });
            
            // Add event listeners to review buttons
            document.querySelectorAll('.review-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const invoiceId = parseInt(this.getAttribute('data-id'));
                    loadInvoiceForReview(invoiceId);
                });
            });
            
            resultsCount.textContent = `${data.length} facturas encontradas`;
            resultsCard.classList.remove('d-none');
        }
        
        function clearSearch() {
            document.getElementById('invoiceNumber').value = '';
            document.getElementById('providerRuc').value = '';
            document.getElementById('statusFilter').value = '';
            resultsCard.classList.add('d-none');
            reviewFormCard.classList.add('d-none');
        }
        
        function loadInvoiceForReview(invoiceId) {
            const invoiceData = invoicesData.find(item => item.id === invoiceId);
            
            if (!invoiceData) {
                showAlert('Factura no encontrada.', 'danger');
                return;
            }
            
            currentInvoice = invoiceData;
            
            // Llenar los datos en el formulario
            document.getElementById('currentInvoiceNumber').textContent = invoiceData.invoice_number;
            document.getElementById('currentInvoiceStatus').textContent = 
                invoiceData.status === 'pending' ? 'Pendiente' : 
                invoiceData.status === 'approved' ? 'Aprobado' : 'Rechazado';
                
            document.getElementById('currentInvoiceStatus').className = 
                invoiceData.status === 'pending' ? 'status-badge status-pending' : 
                invoiceData.status === 'approved' ? 'status-badge status-approved' : 'status-badge status-rejected';
            
            // Tabla comparativa
            document.getElementById('cpDocNumber').textContent = invoiceData.cp_doc_number;
            document.getElementById('invoiceDocNumber').textContent = invoiceData.invoice_number;
            document.getElementById('retentionDocNumber').textContent = invoiceData.retention_doc_number;
            
            document.getElementById('cpEmissionDate').textContent = invoiceData.cp_emission_date;
            document.getElementById('invoiceEmissionDate').textContent = invoiceData.emission_date;
            document.getElementById('retentionEmissionDate').textContent = invoiceData.retention_emission_date;
            
            document.getElementById('cpRuc').textContent = invoiceData.ruc;
            document.getElementById('invoiceRuc').textContent = invoiceData.ruc;
            document.getElementById('retentionRuc').textContent = invoiceData.ruc;
            
            document.getElementById('cpName').textContent = invoiceData.provider;
            document.getElementById('invoiceName').textContent = invoiceData.provider;
            document.getElementById('retentionName').textContent = invoiceData.provider;
            
            document.getElementById('cpWithVAT').textContent = `$${(invoiceData.total_value - invoiceData.retention_rent_base).toFixed(2)}`;
            document.getElementById('cpWithVAT2').textContent = `$0.00`;
            document.getElementById('cpWithoutVAT').textContent = `$${invoiceData.retention_rent_base.toFixed(2)}`;
            
            document.getElementById('invoiceSubtotal').textContent = `$${invoiceData.retention_rent_base.toFixed(2)}`;
            document.getElementById('invoiceIVA12').textContent = `$${invoiceData.retention_iva_base.toFixed(2)}`;
            document.getElementById('invoiceIVA15').textContent = `$0.00`;
            document.getElementById('invoiceTotal').textContent = `$${invoiceData.total_value.toFixed(2)}`;
            
            document.getElementById('retentionRentBase').textContent = `$${invoiceData.retention_rent_base.toFixed(2)}`;
            document.getElementById('retentionIVABase').textContent = `$${invoiceData.retention_iva_base.toFixed(2)}`;
            
            // Verificación de valores
            document.getElementById('verifRentBase').textContent = `$${invoiceData.retention_rent_base.toFixed(2)}`;
            document.getElementById('verifCPValues').textContent = `$${invoiceData.retention_rent_base.toFixed(2)}`;
            document.getElementById('verifSubtotal').textContent = `$${invoiceData.retention_rent_base.toFixed(2)}`;
            
            document.getElementById('verifIVABase').textContent = `$${invoiceData.retention_iva_base.toFixed(2)}`;
            document.getElementById('verifCPIVA').textContent = `$${invoiceData.retention_iva_base.toFixed(2)}`;
            document.getElementById('verifInvoiceIVA').textContent = `$${invoiceData.retention_iva_base.toFixed(2)}`;
            
            // Mostrar el formulario de revisión
            reviewFormCard.classList.remove('d-none');
            
            // Scroll to the review form
            reviewFormCard.scrollIntoView({ behavior: 'smooth' });
            
            showAlert(`Factura ${invoiceData.invoice_number} cargada para revisión.`, 'success');
        }
        
        function approveInvoice() {
            if (!validateForm()) {
                showAlert('Por favor, complete todas las verificaciones requeridas antes de aprobar.', 'warning');
                return;
            }
            
            // Simular aprobación
            showAlert(`Factura ${currentInvoice.invoice_number} aprobada exitosamente.`, 'success');
            
            // Simular cambio de estado
            document.getElementById('currentInvoiceStatus').textContent = 'Aprobado';
            document.getElementById('currentInvoiceStatus').className = 'status-badge status-approved';
            
            // Deshabilitar botones después de la aprobación
            document.getElementById('approveButton').disabled = true;
            document.getElementById('rejectButton').disabled = true;
            document.getElementById('saveButton').disabled = true;
        }
        
        function rejectInvoice() {
            const observations = document.getElementById('additionalObservations').value;
            
            if (!observations) {
                showAlert('Por favor, ingrese las observaciones que justifican el rechazo de la factura.', 'warning');
                return;
            }
            
            // Simular rechazo
            showAlert(`Factura ${currentInvoice.invoice_number} rechazada.`, 'danger');
            
            // Simular cambio de estado
            document.getElementById('currentInvoiceStatus').textContent = 'Rechazado';
            document.getElementById('currentInvoiceStatus').className = 'status-badge status-rejected';
            
            // Deshabilitar botones después del rechazo
            document.getElementById('approveButton').disabled = true;
            document.getElementById('rejectButton').disabled = true;
            document.getElementById('saveButton').disabled = true;
        }
        
        function saveDraft() {
            // Simular guardado de borrador
            showAlert('Progreso de revisión guardado correctamente.', 'info');
        }
        
        function validateForm() {
            // Validar que todos los campos requeridos estén completos
            const requiredSelects = [
                'docMatch', 'dateMatch', 'rucMatch', 'nameMatch', 'valuesMatch',
                'rentBaseMatch', 'ivaBaseMatch', 'contractValidation', 'budgetValidation',
                'invoiceNameValidation', 'purchaseType', 'retentionValidation', 'retentionNumberValidation'
            ];
            
            for (const selectId of requiredSelects) {
                const select = document.getElementById(selectId);
                if (select.value === 'pending' || select.value === '') {
                    showAlert(`Por favor, complete la verificación: ${select.options[0].textContent}`, 'warning');
                    select.focus();
                    return false;
                }
            }
            
            // Validar que todas las casillas del checklist estén marcadas
            for (let i = 1; i <= 12; i++) {
                const checkbox = document.getElementById(`check${i}`);
                if (!checkbox.checked) {
                    showAlert(`Por favor, marque todas las casillas de verificación del checklist.`, 'warning');
                    checkbox.focus();
                    return false;
                }
            }
            
            return true;
        }
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            showAlert('Bienvenido al Sistema de Revisión de Cuentas por Pagar de UNIANDES. Use el formulario de búsqueda para comenzar.', 'info');
        });
    </script>
</body>
</html>